{% extends "base.html" %}

{% block title %}
{% if stream %}{{ stream.title }} - StrophenBoost{% else %}Live Streams - StrophenBoost{% endif %}
{% endblock %}

{% block content %}
{% if stream %}
<!-- Single Stream View -->
<div class="container-fluid py-4">
    <div class="row">
        <!-- Video Player -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-0">
                    {% if stream.is_live %}
                        <!-- Live Stream Video Player -->
                        <div class="position-relative">
                            <!-- Stream Server Selection -->
                            <div class="position-absolute top-0 start-50 translate-middle-x p-3" style="z-index: 10;">
                                <div class="dropdown">
                                    <button class="btn btn-dark btn-sm dropdown-toggle" type="button" id="serverDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-server me-1"></i><span id="currentServer">HLS</span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="serverDropdown">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="switchServer('hls')">
                                                <i class="fas fa-play-circle me-2"></i>HLS
                                                <small class="text-muted d-block">HTTP Live Streaming</small>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="switchServer('dash')">
                                                <i class="fas fa-bolt me-2"></i>DASH
                                                <small class="text-muted d-block">Dynamic Adaptive Streaming</small>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="switchServer('webrtc')">
                                                <i class="fas fa-rocket me-2"></i>WebRTC
                                                <small class="text-muted d-block">Ultra-low latency</small>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <video id="streamPlayer" class="video-js vjs-default-skin w-100" controls preload="auto" width="100%" height="450" 
                                   data-setup='{"fluid": true, "responsive": true, "playbackRates": [0.5, 1, 1.25, 1.5, 2]}'>
                                <source id="hlsSource" src="{{ stream.hls_url }}" type="application/x-mpegURL" />
                                <source id="dashSource" src="{{ stream.dash_url }}" type="application/dash+xml" />
                                <p class="vjs-no-js text-center p-4">
                                    To view this video please enable JavaScript, and consider upgrading to a web browser that
                                    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                                </p>
                            </video>
                            
                            <!-- WebRTC Player (Hidden by default) -->
                            <div id="webrtcPlayer" class="d-none">
                                <video id="webrtcVideo" class="w-100" controls autoplay playsinline style="height: 450px; background: #000;">
                                    <p class="text-center p-4 text-white">
                                        WebRTC connection establishing...
                                    </p>
                                </video>
                            </div>
                            
                            <!-- Live overlay badges -->
                            <div class="position-absolute top-0 start-0 p-3">
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-circle me-1"></i>LIVE
                                </span>
                            </div>
                            <div class="position-absolute top-0 end-0 p-3">
                                <div class="d-flex flex-column gap-2">
                                    <span class="badge bg-dark bg-opacity-75 fs-6">
                                        <i class="fas fa-users me-1"></i><span id="viewerCount">{{ stream.viewer_count or 0 }}</span> viewers
                                    </span>
                                    <!-- Connection Quality Indicator -->
                                    <div class="dropdown">
                                        <span class="badge bg-success fs-6 dropdown-toggle" id="qualityIndicator" data-bs-toggle="dropdown" style="cursor: pointer;">
                                            <i class="fas fa-signal me-1"></i><span id="connectionQuality">HD</span>
                                        </span>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><h6 class="dropdown-header">Quality Settings</h6></li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="changeQuality('1080p')">
                                                    <i class="fas fa-hd-video me-2"></i>1080p Full HD
                                                    <small class="text-muted d-block">High quality</small>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="changeQuality('720p')">
                                                    <i class="fas fa-video me-2"></i>720p HD
                                                    <small class="text-muted d-block">Recommended</small>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="changeQuality('480p')">
                                                    <i class="fas fa-mobile-alt me-2"></i>480p SD
                                                    <small class="text-muted d-block">Mobile friendly</small>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="#" onclick="changeQuality('auto')">
                                                    <i class="fas fa-magic me-2"></i>Auto
                                                    <small class="text-muted d-block">Adaptive quality</small>
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <div class="dropdown-item-text">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Latency: <span id="latencyInfo">2-5s</span>
                                                    </small>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fallback for when stream is not available -->
                            <div id="streamFallback" class="position-absolute top-0 start-0 w-100 h-100 d-none">
                                <div class="d-flex align-items-center justify-content-center h-100 stream-placeholder">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <h4><i class="fas fa-broadcast-tower me-2"></i>Connecting to Stream</h4>
                                        <p class="mb-3">Please wait while we establish the connection...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center bg-dark text-white" style="height: 450px;">
                            <div class="text-center">
                                <i class="fas fa-video-slash fa-3x mb-3"></i>
                                <h4>Stream Offline</h4>
                                <p class="text-muted">This stream is currently not broadcasting</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Stream Information -->
            <div class="card mt-3">
                <div class="card-body">
                    <!-- Broadcaster Info Header -->
                    <div class="d-flex align-items-start mb-4">
                        <div class="broadcaster-avatar me-3">
                            <img src="{{ stream.broadcaster.avatar_url or '/static/images/default-avatar.svg' }}" 
                                 alt="{{ stream.broadcaster.username }}" 
                                 class="rounded-circle" 
                                 width="60" 
                                 height="60"
                                 style="object-fit: cover;">
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h4 class="mb-1" id="streamTitle">{{ stream.title }}</h4>
                                    <div class="broadcaster-info mb-2">
                                        <a href="/profile/{{ stream.broadcaster.username }}" class="text-decoration-none">
                                            <strong class="text-primary">{{ stream.broadcaster.display_name or stream.broadcaster.username }}</strong>
                                        </a>
                                        <span class="text-muted ms-2">@{{ stream.broadcaster.username }}</span>
                                        {% if stream.broadcaster.is_broadcaster %}
                                            <span class="badge bg-success ms-2">
                                                <i class="fas fa-star me-1"></i>Creator
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="stream-stats d-flex align-items-center text-muted">
                                        <span class="me-3">
                                            <i class="fas fa-eye me-1"></i><span id="totalViews">{{ stream.total_views }}</span> views
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-users me-1"></i><span id="currentViewers">{{ stream.viewer_count }}</span> watching
                                        </span>
                                        {% if stream.is_live %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-circle me-1"></i>LIVE
                                            </span>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-clock me-1"></i>{{ stream.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="stream-actions">
                                    {% if session.user_id == stream.broadcaster_id %}
                                        <button class="btn btn-outline-primary btn-sm me-2" onclick="editStreamInfo()">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                    {% endif %}
                                    {% if stream.allow_embedding %}
                                        <button class="btn btn-outline-secondary btn-sm" onclick="showEmbedCode({{ stream.id }})">
                                            <i class="fas fa-code me-1"></i>Embed
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stream Description -->
                    <div class="stream-description mb-3">
                        <div id="streamDescriptionView">
                            <p class="mb-2" id="streamDescriptionText">
                                {{ stream.description or 'No description provided.' }}
                            </p>
                        </div>
                        
                        <!-- Edit Form (Hidden by default) -->
                        <div id="streamDescriptionEdit" class="d-none">
                            <form id="editStreamForm">
                                <div class="mb-3">
                                    <label for="editTitle" class="form-label">Stream Title</label>
                                    <input type="text" class="form-control" id="editTitle" value="{{ stream.title }}" maxlength="200" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editDescription" rows="4" maxlength="1000">{{ stream.description or '' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editHashtags" class="form-label">Hashtags</label>
                                    <input type="text" class="form-control" id="editHashtags" 
                                           value="{{ stream.hashtags or '' }}" 
                                           placeholder="gaming, live, entertainment (comma separated)"
                                           maxlength="500">
                                    <small class="text-muted">Separate hashtags with commas. Maximum 10 hashtags.</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Hashtags -->
                    <div class="stream-hashtags" id="streamHashtags">
                        {% if stream.hashtags %}
                            {% set hashtag_list = stream.hashtags.split(',') %}
                            {% for hashtag in hashtag_list %}
                                {% if hashtag.strip() %}
                                    <span class="badge bg-light text-dark me-2 mb-2">
                                        #{{ hashtag.strip() }}
                                    </span>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Additional Stream Actions -->
                    <div class="stream-additional-actions mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="followStreamer()">
                                        <i class="fas fa-heart me-1"></i>Follow
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="shareStream()">
                                        <i class="fas fa-share me-1"></i>Share
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="reportStream()">
                                        <i class="fas fa-flag me-1"></i>Report
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    {% if stream.started_at %}
                                        Started {{ stream.started_at.strftime('%I:%M %p') }}
                                    {% endif %}
                                    {% if stream.ended_at %}
                                        • Ended {{ stream.ended_at.strftime('%I:%M %p') }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat -->
        <div class="col-lg-4">
            {% if stream.chat_enabled %}
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-comments me-2"></i>Live Chat
                        </h6>
                        <span class="badge bg-primary" id="chatUserCount">0</span>
                    </div>
                    <div class="card-body d-flex flex-column p-0">
                        <div id="chatMessages" class="flex-grow-1 p-3" style="height: 400px; overflow-y: auto;">
                            <!-- Real-time chat messages will be populated here -->
                            <div class="text-center text-muted py-4" id="chatPlaceholder">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p class="mb-0">Connecting to chat...</p>
                            </div>
                        </div>
                        <div class="p-3 border-top">
                            <div class="input-group">
                                <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." maxlength="500">
                                <button class="btn btn-primary" onclick="sendChatMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-slash fa-3x mb-3"></i>
                            <h5>Chat Disabled</h5>
                            <p>Chat is not available for this stream</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
<!-- Stream Listing -->
<div class="container py-4">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-center py-5">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-broadcast-tower me-3"></i>StrophenBoost
                    </h1>
                    <p class="lead mb-4">Advanced streaming platform with RTMP support, FFmpeg processing, and cross-website integration</p>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <i class="fas fa-stream fa-2x mb-2"></i>
                            <h5>RTMP Ingestion</h5>
                            <p class="small">Professional streaming with multiple RTMP sources</p>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-code fa-2x mb-2"></i>
                            <h5>Embeddable Player</h5>
                            <p class="small">Embed streams on any website with customizable options</p>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <h5>Real-time Analytics</h5>
                            <p class="small">Monitor viewers, bandwidth, and stream performance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Streams -->
    {% if streams %}
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-fire text-danger me-2"></i>Live Now
                    <span class="badge bg-danger">{{ streams|length }}</span>
                </h2>
            </div>
        </div>
        
        <div class="row">
            {% for stream in streams %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 stream-card">
                        <div class="position-relative">
                            {% if stream.is_live %}
                                <div class="stream-thumbnail bg-dark d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <div class="text-center text-white">
                                        <i class="fas fa-play-circle fa-3x mb-2"></i>
                                        <p class="mb-0">Click to Watch</p>
                                    </div>
                                </div>
                                <span class="position-absolute top-0 start-0 badge bg-danger m-2">
                                    <i class="fas fa-circle me-1"></i>LIVE
                                </span>
                                <span class="position-absolute top-0 end-0 badge bg-dark m-2">
                                    <i class="fas fa-eye me-1"></i>{{ stream.viewer_count }}
                                </span>
                            {% else %}
                                <div class="stream-thumbnail bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <div class="text-center text-white">
                                        <i class="fas fa-video-slash fa-3x mb-2"></i>
                                        <p class="mb-0">Offline</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ stream.title }}</h5>
                            <p class="card-text text-muted">{{ stream.description[:100] }}{% if stream.description|length > 100 %}...{% endif %}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>{{ stream.broadcaster.username }}
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-eye me-1"></i>{{ stream.total_views }} views
                                </small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="{{ url_for('view_stream', stream_id=stream.id) }}" class="btn btn-primary w-100">
                                {% if stream.is_live %}
                                    <i class="fas fa-play me-1"></i>Watch Live
                                {% else %}
                                    <i class="fas fa-info me-1"></i>View Details
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-video fa-3x text-muted mb-4"></i>
                        <h3 class="text-muted">No Live Streams</h3>
                        <p class="text-muted mb-4">There are currently no live streams available.</p>
                        {% if not session.user_id %}
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
                                <i class="fas fa-user-plus me-2"></i>Register to Start Streaming
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Embed Code Modal -->
<div class="modal fade" id="embedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code me-2"></i>Embed This Stream
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Iframe Embed Code</label>
                    <textarea class="form-control" id="embedCode" rows="4" readonly></textarea>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyEmbedCode()">
                        <i class="fas fa-copy me-1"></i>Copy to Clipboard
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Direct Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="embedUrl" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyEmbedUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/stream.js') }}"></script>
{% if stream and stream.chat_enabled %}
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script>
        // Initialize chat for this stream
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat({{ stream.id }});
        });
    </script>
{% endif %}
{% if stream %}
    <script>
        // Stream-specific JavaScript
        const streamId = {{ stream.id }};
        const isLive = {{ stream.is_live|tojson }};
        const isOwner = {{ (session.user_id == stream.broadcaster_id)|tojson }};
        
        // Initialize video player for live streams
        if (isLive) {
            initializeVideoPlayer();
            
            // Handle stream loading errors
            setTimeout(() => {
                const player = videojs('streamPlayer');
                if (player) {
                    player.on('error', function() {
                        console.log('Stream connection failed, showing fallback');
                        document.getElementById('streamFallback').classList.remove('d-none');
                    });
                    
                    player.on('loadstart', function() {
                        console.log('Stream loading started');
                        document.getElementById('streamFallback').classList.add('d-none');
                    });
                }
            }, 1000);
        }
        
        // Stream server switching functionality
        let currentServerType = 'hls';
        let videoPlayer = null;
        let webrtcConnection = null;
        
        // Initialize stream servers
        const streamServers = {
            hls: '{{ stream.hls_url or "/stream/" + stream.id|string + "/hls/index.m3u8" }}',
            dash: '{{ stream.dash_url or "/stream/" + stream.id|string + "/dash/index.mpd" }}',
            webrtc: '{{ stream.webrtc_url or "ws://localhost:8080/webrtc/" + stream.id|string }}'
        };
        
        function switchServer(serverType) {
            if (currentServerType === serverType) return;
            
            // Show loading state
            document.getElementById('qualityIndicator').className = 'badge bg-warning fs-6 connection-loading';
            document.getElementById('connectionQuality').textContent = 'Switching...';
            document.getElementById('currentServer').textContent = serverType.toUpperCase();
            
            // Add switching animation
            const playerContainer = document.querySelector('.position-relative');
            playerContainer.classList.add('server-switching');
            
            setTimeout(() => {
                switch(serverType) {
                    case 'hls':
                        switchToHLS();
                        break;
                    case 'dash':
                        switchToDASH();
                        break;
                    case 'webrtc':
                        switchToWebRTC();
                        break;
                }
                currentServerType = serverType;
                
                // Remove switching animation
                playerContainer.classList.remove('server-switching');
                
                // Update quality indicator
                setTimeout(() => {
                    updateQualityIndicator(serverType);
                }, 1000);
            }, 500);
        }
        
        function switchToHLS() {
            // Hide WebRTC player
            document.getElementById('webrtcPlayer').classList.add('d-none');
            document.getElementById('streamPlayer').classList.remove('d-none');
            
            // Dispose existing player if exists
            if (videoPlayer) {
                videoPlayer.dispose();
            }
            
            // Initialize new HLS player
            videoPlayer = videojs('streamPlayer', {
                fluid: true,
                responsive: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2]
            });
            
            videoPlayer.src({
                src: streamServers.hls,
                type: 'application/x-mpegURL'
            });
            
            videoPlayer.ready(() => {
                videoPlayer.play();
                showAlert('success', 'Switched to HLS server - Best compatibility');
            });
        }
        
        function switchToDASH() {
            // Hide WebRTC player
            document.getElementById('webrtcPlayer').classList.add('d-none');
            document.getElementById('streamPlayer').classList.remove('d-none');
            
            // Dispose existing player if exists
            if (videoPlayer) {
                videoPlayer.dispose();
            }
            
            // Initialize new DASH player
            videoPlayer = videojs('streamPlayer', {
                fluid: true,
                responsive: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2]
            });
            
            videoPlayer.src({
                src: streamServers.dash,
                type: 'application/dash+xml'
            });
            
            videoPlayer.ready(() => {
                videoPlayer.play();
                showAlert('success', 'Switched to DASH server - Adaptive quality');
            });
        }
        
        function switchToWebRTC() {
            // Hide regular player
            document.getElementById('streamPlayer').classList.add('d-none');
            document.getElementById('webrtcPlayer').classList.remove('d-none');
            
            // Dispose existing video player
            if (videoPlayer) {
                videoPlayer.dispose();
                videoPlayer = null;
            }
            
            // Initialize WebRTC connection
            initializeWebRTC();
        }
        
        function initializeWebRTC() {
            const webrtcVideo = document.getElementById('webrtcVideo');
            
            // For demo purposes, show a placeholder
            // In a real implementation, you would establish WebRTC connection
            webrtcVideo.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100 bg-dark text-white">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Connecting...</span>
                        </div>
                        <h5><i class="fas fa-rocket me-2"></i>WebRTC Connection</h5>
                        <p class="mb-0">Ultra-low latency streaming</p>
                        <small class="text-muted">Establishing peer-to-peer connection...</small>
                    </div>
                </div>
            `;
            
            // Simulate connection establishment
            setTimeout(() => {
                showAlert('info', 'WebRTC server - Ultra-low latency (Demo mode)');
                // In real implementation, replace with actual WebRTC stream
                webrtcVideo.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100 bg-gradient-to-br from-blue-900 to-purple-900 text-white">
                        <div class="text-center">
                            <i class="fas fa-rocket fa-3x mb-3 text-primary"></i>
                            <h4>WebRTC Stream Active</h4>
                            <p class="mb-2">Ultra-low latency: ~50ms</p>
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>Connected via peer-to-peer
                            </small>
                        </div>
                    </div>
                `;
            }, 2000);
        }
        
        function updateQualityIndicator(serverType) {
            const indicator = document.getElementById('qualityIndicator');
            const quality = document.getElementById('connectionQuality');
            const latencyInfo = document.getElementById('latencyInfo');
            
            // Remove all quality classes
            indicator.className = 'badge fs-6 dropdown-toggle';
            indicator.style.cursor = 'pointer';
            
            switch(serverType) {
                case 'hls':
                    indicator.classList.add('bg-success', 'quality-hd');
                    quality.textContent = 'HD';
                    latencyInfo.textContent = '2-10s';
                    break;
                case 'dash':
                    indicator.classList.add('bg-info', 'quality-fullhd');
                    quality.textContent = 'FHD';
                    latencyInfo.textContent = '1-5s';
                    break;
                case 'webrtc':
                    indicator.classList.add('bg-primary', 'quality-4k');
                    quality.textContent = 'ULL';
                    latencyInfo.textContent = '50-200ms';
                    break;
            }
        }
        
        // Quality change functionality
        function changeQuality(qualityLevel) {
            const qualityText = document.getElementById('connectionQuality');
            
            // Show loading state
            const indicator = document.getElementById('qualityIndicator');
            indicator.classList.add('connection-loading');
            qualityText.textContent = 'Changing...';
            
            // Send quality change request
            fetch(`/stream/${streamId}/switch-quality`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quality: qualityLevel,
                    server_type: currentServerType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update quality display
                    switch(qualityLevel) {
                        case '1080p':
                            qualityText.textContent = 'FHD';
                            break;
                        case '720p':
                            qualityText.textContent = 'HD';
                            break;
                        case '480p':
                            qualityText.textContent = 'SD';
                            break;
                        case 'auto':
                            qualityText.textContent = 'AUTO';
                            break;
                        default:
                            qualityText.textContent = 'HD';
                    }
                    
                    showAlert('success', data.message);
                    
                    // Refresh player with new quality (simulate)
                    if (videoPlayer) {
                        setTimeout(() => {
                            // In real implementation, this would switch to different quality stream
                            videoPlayer.trigger('loadstart');
                        }, 500);
                    }
                } else {
                    showAlert('danger', data.error || 'Failed to change quality');
                    qualityText.textContent = 'HD'; // Reset to default
                }
            })
            .catch(error => {
                showAlert('danger', 'Error changing quality: ' + error.message);
                qualityText.textContent = 'HD'; // Reset to default
            })
            .finally(() => {
                indicator.classList.remove('connection-loading');
            });
        }
        
        // Stream analytics and monitoring
        function getStreamAnalytics() {
            fetch(`/stream/${streamId}/quality`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Stream Analytics:', data);
                    // Update UI with connection stats if needed
                }
            })
            .catch(error => {
                console.log('Analytics error:', error);
            });
        }
        
        // Initialize analytics monitoring
        if (isLive) {
            // Update analytics every 30 seconds
            setInterval(getStreamAnalytics, 30000);
        }
        
        // Stream editing functionality
        function editStreamInfo() {
            document.getElementById('streamDescriptionView').classList.add('d-none');
            document.getElementById('streamDescriptionEdit').classList.remove('d-none');
        }
        
        function cancelEdit() {
            document.getElementById('streamDescriptionView').classList.remove('d-none');
            document.getElementById('streamDescriptionEdit').classList.add('d-none');
        }
        
        // Handle stream edit form submission
        document.getElementById('editStreamForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            submitBtn.disabled = true;
            
            const formData = {
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value,
                hashtags: document.getElementById('editHashtags').value
            };
            
            fetch(`/stream/${streamId}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the display with new information
                    document.getElementById('streamTitle').textContent = data.stream.title;
                    document.getElementById('streamDescriptionText').textContent = data.stream.description || 'No description provided.';
                    
                    // Update hashtags
                    const hashtagsContainer = document.getElementById('streamHashtags');
                    if (data.stream.hashtags) {
                        const hashtags = data.stream.hashtags.split(',');
                        hashtagsContainer.innerHTML = hashtags.map(tag => 
                            `<span class="badge bg-light text-dark me-2 mb-2">#${tag.trim()}</span>`
                        ).join('');
                    } else {
                        hashtagsContainer.innerHTML = '';
                    }
                    
                    // Hide edit form and show view
                    cancelEdit();
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.error || 'Failed to update stream information');
                }
            })
            .catch(error => {
                showAlert('danger', 'Error updating stream: ' + error.message);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Follow streamer functionality
        function followStreamer() {
            if (!{{ session.user_id|tojson }}) {
                showAlert('warning', 'Please login to follow streamers');
                return;
            }
            
            fetch(`/stream/${streamId}/follow`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.error || 'Failed to follow streamer');
                }
            })
            .catch(error => {
                showAlert('danger', 'Error following streamer: ' + error.message);
            });
        }
        
        // Share stream functionality
        function shareStream() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('streamTitle').textContent,
                    url: url
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('success', 'Stream link copied to clipboard!');
                });
            }
        }
        
        // Report stream functionality
        function reportStream() {
            if (!{{ session.user_id|tojson }}) {
                showAlert('warning', 'Please login to report streams');
                return;
            }
            
            const reason = prompt('Please provide a reason for reporting this stream:');
            if (reason && reason.trim()) {
                fetch(`/stream/${streamId}/report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', data.message);
                    } else {
                        showAlert('danger', data.error || 'Failed to report stream');
                    }
                })
                .catch(error => {
                    showAlert('danger', 'Error reporting stream: ' + error.message);
                });
            }
        }
        
        // Alert helper function
        function showAlert(type, message) {
            const alertContainer = document.querySelector('.container-fluid');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Real-time features temporarily disabled for performance
        // When SocketIO is re-enabled, uncomment the following:
        // socket.emit('join_stream', {
        //     stream_id: streamId,
        //     username: '{{ session.username or "Anonymous" }}'
        // });
        
        // socket.on('viewer_update', function(data) {
        //     document.getElementById('viewerCount').textContent = data.count;
        // });
    </script>
{% endif %}
{% endblock %}
